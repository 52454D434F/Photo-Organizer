#!/bin/sh

# Synology Package Start/Stop/Status Script for Photo Organizer

INSTALL_DIR="/var/packages/photo-organizer"
PYTHON3_PATH="/usr/bin/python3"
PID_FILE="${INSTALL_DIR}/var/photo-organizer.pid"
SCRIPT_PATH="${INSTALL_DIR}/target/organize_photos.py"

case "$1" in
    start)
        if [ -f "${PID_FILE}" ]; then
            if ps -p $(cat ${PID_FILE}) > /dev/null 2>&1; then
                echo "Photo Organizer is already running"
                exit 0
            fi
        fi
        
        if [ ! -f "${SCRIPT_PATH}" ]; then
            echo "Error: Photo Organizer script not found at ${SCRIPT_PATH}"
            exit 1
        fi
        
        nohup ${PYTHON3_PATH} ${SCRIPT_PATH} > ${INSTALL_DIR}/var/photo-organizer.log 2>&1 &
        echo $! > ${PID_FILE}
        echo "Photo Organizer started"
        ;;
        
    stop)
        if [ -f "${PID_FILE}" ]; then
            PID=$(cat ${PID_FILE})
            if ps -p ${PID} > /dev/null 2>&1; then
                kill ${PID}
                echo "Photo Organizer stopped"
            else
                echo "Photo Organizer was not running"
            fi
            rm -f ${PID_FILE}
        else
            echo "Photo Organizer was not running"
        fi
        ;;
        
    status)
        if [ -f "${PID_FILE}" ]; then
            PID=$(cat ${PID_FILE})
            if ps -p ${PID} > /dev/null 2>&1; then
                echo "Photo Organizer is running (PID: ${PID})"
                exit 0
            else
                echo "Photo Organizer is not running (stale PID file)"
                rm -f ${PID_FILE}
                exit 1
            fi
        else
            echo "Photo Organizer is not running"
            exit 1
        fi
        ;;
        
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac

exit 0

